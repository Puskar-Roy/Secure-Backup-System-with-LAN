
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin Panel - Backup Server</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --slate-50: #f8fafc;
      --slate-100: #f1f5f9;
      --slate-200: #e2e8f0;
      --slate-300: #cbd5e1;
      --slate-400: #94a3b8;
      --slate-500: #64748b;
      --slate-600: #475569;
      --slate-700: #334155;
      --slate-800: #1e293b;
      --slate-900: #0f172a;
      --white: #ffffff;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--slate-50);
      color: var(--slate-900);
      line-height: 1.6;
    }
    
    .header {
      background: var(--white);
      padding: 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      border-bottom: 1px solid var(--slate-200);
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .logo {
      width: 40px;
      height: 40px;
      background: var(--slate-900);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-size: 20px;
    }
    
    .header h1 {
      font-size: 22px;
      font-weight: 600;
      color: var(--slate-900);
      letter-spacing: -0.5px;
    }
    
    .header-right {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--slate-100);
      border-radius: 8px;
      font-size: 14px;
      color: var(--slate-700);
      font-weight: 500;
    }
    
    .user-info i {
      color: var(--slate-500);
    }
    
    .btn {
      padding: 10px 18px;
      background: var(--slate-900);
      color: var(--white);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    
    .btn:hover {
      background: var(--slate-800);
      transform: translateY(-1px);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-secondary {
      background: var(--white);
      color: var(--slate-700);
      border: 1px solid var(--slate-300);
    }
    
    .btn-secondary:hover {
      background: var(--slate-50);
      border-color: var(--slate-400);
    }
    
    .btn-danger {
      background: var(--danger);
      color: var(--white);
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px;
    }
    
    .card {
      background: var(--white);
      border-radius: 12px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      border: 1px solid var(--slate-200);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .card h2 {
      font-size: 18px;
      font-weight: 600;
      color: var(--slate-900);
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: -0.3px;
    }
    
    .card h2 i {
      color: var(--slate-600);
      font-size: 20px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: var(--white);
      border: 1px solid var(--slate-200);
      padding: 24px;
      border-radius: 12px;
      transition: all 0.2s;
    }
    
    .stat-card:hover {
      border-color: var(--slate-300);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }
    
    .stat-icon {
      width: 48px;
      height: 48px;
      background: var(--slate-100);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      color: var(--slate-700);
      font-size: 22px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--slate-900);
      margin-bottom: 4px;
      letter-spacing: -1px;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--slate-600);
      font-weight: 500;
    }
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--slate-700);
      font-weight: 500;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 11px 14px;
      border: 1px solid var(--slate-300);
      border-radius: 8px;
      font-size: 14px;
      color: var(--slate-900);
      background: var(--white);
      transition: all 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--slate-400);
      box-shadow: 0 0 0 3px rgba(100, 116, 139, 0.1);
    }
    
    .input-group {
      display: flex;
      gap: 8px;
    }
    
    .input-group input {
      flex: 1;
    }
    
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--slate-200);
      background: var(--white);
      border-radius: 12px 12px 0 0;
      padding: 8px 8px 0 8px;
    }
    
    .tab {
      padding: 12px 20px;
      background: none;
      border: none;
      color: var(--slate-600);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px 8px 0 0;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tab:hover {
      color: var(--slate-900);
      background: var(--slate-100);
    }
    
    .tab.active {
      color: var(--slate-900);
      background: var(--slate-100);
      font-weight: 600;
    }
    
    .tab i {
      font-size: 16px;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    .storage-list {
      list-style: none;
    }
    
    .storage-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 18px;
      border: 1px solid var(--slate-200);
      border-radius: 10px;
      margin-bottom: 10px;
      background: var(--slate-50);
      transition: all 0.2s;
    }
    
    .storage-item:hover {
      border-color: var(--slate-300);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    
    .storage-item.active {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border-color: var(--success);
    }
    
    .storage-path {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
      font-size: 13px;
      color: var(--slate-800);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .storage-badge {
      padding: 4px 10px;
      background: var(--success);
      color: var(--white);
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .storage-actions {
      display: flex;
      gap: 6px;
    }
    
    .btn-small {
      padding: 7px 14px;
      font-size: 13px;
    }
    
    .success-msg {
      padding: 14px 16px;
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      font-weight: 500;
      font-size: 14px;
      border: 1px solid #86efac;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid #e0e0e0;
    }
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      border: none;
      background: none;
      color: #666;
      font-size: 14px;
      font-weight: 500;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    .tab:hover {
      color: #667eea;
    }
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    
    /* Folder Browser Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(4px);
    }
    
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: var(--white);
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      border: 1px solid var(--slate-200);
    }
    
    .modal-header {
      padding: 20px 28px;
      border-bottom: 1px solid var(--slate-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--slate-50);
      border-radius: 16px 16px 0 0;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--slate-900);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .modal-close {
      background: var(--slate-100);
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--slate-600);
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .modal-close:hover {
      background: var(--slate-200);
      color: var(--slate-900);
    }
    
    .modal-body {
      padding: 24px 28px;
      overflow-y: auto;
      flex: 1;
    }
    
    .modal-footer {
      padding: 20px 28px;
      border-top: 1px solid var(--slate-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      background: var(--slate-50);
      border-radius: 0 0 16px 16px;
    }
    
    .breadcrumb-browser {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      padding: 12px 14px;
      background: var(--slate-100);
      border-radius: 8px;
      font-size: 13px;
      overflow-x: auto;
      white-space: nowrap;
      font-family: 'SF Mono', Monaco, monospace;
    }
    
    .breadcrumb-browser-item {
      cursor: pointer;
      color: var(--slate-700);
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .breadcrumb-browser-item:hover {
      color: var(--slate-900);
    }
    
    .drives-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 14px;
      margin-bottom: 20px;
    }
    
    .drive-item {
      padding: 20px 16px;
      border: 1px solid var(--slate-200);
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      background: var(--white);
    }
    
    .drive-item:hover {
      border-color: var(--slate-400);
      background: var(--slate-50);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .drive-icon {
      font-size: 28px;
      margin-bottom: 10px;
      color: var(--slate-600);
    }
    
    .folder-list {
      list-style: none;
      padding: 0;
    }
    
    .folder-item {
      padding: 14px 16px;
      border: 1px solid var(--slate-200);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s;
      background: var(--white);
    }
    
    .folder-item:hover {
      background: var(--slate-50);
      border-color: var(--slate-300);
      transform: translateX(4px);
    }
    
    .folder-item.selected {
      background: var(--slate-100);
      border-color: var(--slate-400);
    }
    
    .folder-icon-browser {
      font-size: 18px;
      color: var(--slate-600);
    }
    
    .selected-path {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      color: var(--slate-700);
      font-weight: 500;
      flex: 1;
      font-size: 13px;
    }
    
    .backup-item {
      border: 1px solid var(--slate-200);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 14px;
      transition: all 0.2s;
      background: var(--white);
    }
    
    .backup-item:hover {
      border-color: var(--slate-300);
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      transform: translateY(-2px);
    }
    
    .backup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .backup-title {
      font-weight: 600;
      font-size: 15px;
      color: var(--slate-900);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .backup-title i {
      color: var(--slate-600);
    }
    
    .backup-actions {
      display: flex;
      gap: 8px;
    }
    
    .backup-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin-top: 14px;
      font-size: 13px;
    }
    
    .backup-info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .backup-info-label {
      font-weight: 500;
      color: var(--slate-500);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .backup-info-value {
      color: var(--slate-900);
      font-weight: 600;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="header-left">
        <div class="logo">
          <i class="fas fa-database"></i>
        </div>
        <h1>Backup Server</h1>
      </div>
      <div class="header-right">
        <div class="user-info">
          <i class="fas fa-user-circle"></i>
          <span><%= username %></span>
        </div>
        <a href="/explorer" class="btn btn-secondary" target="_blank">
          <i class="fas fa-folder-open"></i>
          Explorer
        </a>
        <button onclick="logout()" class="btn btn-danger">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-archive"></i></div>
        <div class="stat-value" id="totalBackups">-</div>
        <div class="stat-label">Total Backups</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-hdd"></i></div>
        <div class="stat-value" id="totalStorage">-</div>
        <div class="stat-label">Storage Used</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
        <div class="stat-value" id="totalFiles">-</div>
        <div class="stat-label">Unique Files</div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('storage')">
        <i class="fas fa-server"></i>
        Storage Configuration
      </button>
      <button class="tab" onclick="switchTab('backups')">
        <i class="fas fa-box-open"></i>
        Backups
      </button>
      <button class="tab" onclick="switchTab('settings')">
        <i class="fas fa-cog"></i>
        Settings
      </button>
    </div>

    <div class="tab-content active" id="storage-tab">
      <div class="card">
        <h2>
          <i class="fas fa-server"></i>
          Storage Locations
        </h2>
        <div class="success-msg" id="storageSuccess"></div>
        <ul class="storage-list" id="storageList"></ul>
        <div class="form-group" style="margin-top: 24px;">
          <label>Add New Storage Location</label>
          <div class="input-group">
            <input type="text" id="newStoragePath" placeholder="/path/to/storage or D:\\Backups">
            <button onclick="openFolderBrowser()" class="btn btn-secondary">
              <i class="fas fa-folder-open"></i>
              Browse
            </button>
          </div>
          <button onclick="addStorage()" class="btn" style="margin-top: 8px; width: 100%;">
            <i class="fas fa-plus"></i>
            Add Storage Location
          </button>
        </div>
      </div>
    </div>

    <!-- Folder Browser Modal -->
    <div id="folderBrowserModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>
            <i class="fas fa-folder-open"></i>
            Select Folder
          </h3>
          <button class="modal-close" onclick="closeFolderBrowser()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div id="drivesSection" style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 16px; color: var(--slate-700); font-size: 14px; font-weight: 600;">Select Drive:</h4>
            <div id="drivesList" class="drives-list"></div>
          </div>
          <div id="folderSection" style="display: none;">
            <div class="breadcrumb-browser" id="breadcrumbBrowser"></div>
            <ul id="folderList" class="folder-list"></ul>
          </div>
          <div id="browserLoading" style="display: none; text-align: center; padding: 40px; color: var(--slate-600);">
            <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px;"></i>
            <div>Loading folders...</div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="selected-path" id="selectedPathDisplay">No folder selected</div>
          <button onclick="selectCurrentFolder()" class="btn">
            <i class="fas fa-check"></i>
            Select This Folder
          </button>
        </div>
      </div>
    </div>

    <div class="tab-content" id="backups-tab">
      <div class="card">
        <h2>
          <i class="fas fa-box-open"></i>
          Backup Management
        </h2>
        <div class="success-msg" id="backupSuccess"></div>
        <div style="margin-bottom: 24px; display: flex; gap: 10px;">
          <button onclick="loadBackups()" class="btn btn-secondary">
            <i class="fas fa-sync-alt"></i>
            Refresh
          </button>
          <button onclick="deleteOldBackups()" class="btn btn-danger">
            <i class="fas fa-trash-alt"></i>
            Delete Old Backups
          </button>
        </div>
        <div id="backupsLoading" style="text-align: center; padding: 60px; color: var(--slate-500); display: none;">
          <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 16px; display: block;"></i>
          <div style="font-weight: 500;">Loading backups...</div>
        </div>
        <div id="backupsList" style="max-height: 600px; overflow-y: auto;"></div>
      </div>
    </div>

    <div class="tab-content" id="settings-tab">
      <div class="card">
        <h2>
          <i class="fas fa-key"></i>
          Change Password
        </h2>
        <div class="success-msg" id="passwordSuccess"></div>
        <form id="passwordForm">
          <div class="form-group">
            <label>Current Password</label>
            <input type="password" id="currentPassword" required>
          </div>
          <div class="form-group">
            <label>New Password</label>
            <input type="password" id="newPassword" required>
          </div>
          <div class="form-group">
            <label>Confirm New Password</label>
            <input type="password" id="confirmPassword" required>
          </div>
          <button type="submit" class="btn">
            <i class="fas fa-save"></i>
            Change Password
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    async function loadStats() {
      try {
        const response = await fetch('/api/stats');
        const data = await response.json();
        document.getElementById('totalBackups').textContent = data.totalBackups;
        document.getElementById('totalStorage').textContent = formatBytes(data.totalStorage);
        document.getElementById('totalFiles').textContent = data.totalFiles;
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    async function loadStorageConfig() {
      try {
        const response = await fetch('/api/config');
        const data = await response.json();
        const list = document.getElementById('storageList');
        list.innerHTML = '';
        
        data.storageLocations.forEach((location, index) => {
          const li = document.createElement('li');
          li.className = 'storage-item' + (index === data.activeStorageIndex ? ' active' : '');
          li.innerHTML = `
            <span class="storage-path">
              ${index === data.activeStorageIndex ? '<span class="storage-badge">Active</span>' : '<i class="fas fa-folder" style="color: var(--slate-500);"></i>'}
              ${location}
            </span>
            <div class="storage-actions">
              ${index !== data.activeStorageIndex ? 
                '<button class="btn btn-small btn-secondary" onclick="setActiveStorage(' + index + ')"><i class="fas fa-check"></i> Set Active</button>' : ''}
              ${data.storageLocations.length > 1 ? 
                '<button class="btn btn-small btn-danger" onclick="removeStorage(' + index + ')"><i class="fas fa-trash-alt"></i></button>' : ''}
            </div>
          `;
          list.appendChild(li);
        });
      } catch (err) {
        console.error('Failed to load storage config:', err);
      }
    }

    async function addStorage() {
      const path = document.getElementById('newStoragePath').value.trim();
      if (!path) return alert('Please enter a storage path');
      
      try {
        const response = await fetch('/api/config/storage', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path })
        });
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('newStoragePath').value = '';
          showSuccess('storageSuccess', 'Storage location added successfully!');
          loadStorageConfig();
        } else {
          alert(data.error || 'Failed to add storage');
        }
      } catch (err) {
        alert('Failed to add storage: ' + err.message);
      }
    }

    async function setActiveStorage(index) {
      try {
        const response = await fetch('/api/config/storage/active', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ index })
        });
        const data = await response.json();
        
        if (data.success) {
          showSuccess('storageSuccess', 'Active storage location updated!');
          loadStorageConfig();
        } else {
          alert(data.error || 'Failed to set active storage');
        }
      } catch (err) {
        alert('Failed to set active storage: ' + err.message);
      }
    }

    async function removeStorage(index) {
      if (!confirm('Are you sure you want to remove this storage location?')) return;
      
      try {
        const response = await fetch('/api/config/storage/' + index, {
          method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
          showSuccess('storageSuccess', 'Storage location removed!');
          loadStorageConfig();
        } else {
          alert(data.error || 'Failed to remove storage');
        }
      } catch (err) {
        alert('Failed to remove storage: ' + err.message);
      }
    }

    async function logout() {
      await fetch('/api/logout', { method: 'POST' });
      window.location.href = '/login';
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Load backups when switching to backups tab
      if (tabName === 'backups') {
        loadBackups();
      }
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showSuccess(id, message) {
      const el = document.getElementById(id);
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const current = document.getElementById('currentPassword').value;
      const newPass = document.getElementById('newPassword').value;
      const confirm = document.getElementById('confirmPassword').value;
      
      if (newPass !== confirm) {
        return alert('New passwords do not match');
      }
      
      try {
        const response = await fetch('/api/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentPassword: current, newPassword: newPass })
        });
        const data = await response.json();
        
        if (data.success) {
          showSuccess('passwordSuccess', 'Password changed successfully!');
          document.getElementById('passwordForm').reset();
        } else {
          alert(data.error || 'Failed to change password');
        }
      } catch (err) {
        alert('Failed to change password: ' + err.message);
      }
    });

    // Load data on page load
    loadStats();
    loadStorageConfig();
    
    // Folder Browser Functions
    let currentBrowserPath = '';
    let selectedFolderPath = '';
    
    async function openFolderBrowser() {
      document.getElementById('folderBrowserModal').classList.add('show');
      currentBrowserPath = '';
      selectedFolderPath = '';
      document.getElementById('selectedPathDisplay').textContent = 'No folder selected';
      document.getElementById('drivesSection').style.display = 'block';
      document.getElementById('folderSection').style.display = 'none';
      await loadDrives();
    }
    
    function closeFolderBrowser() {
      document.getElementById('folderBrowserModal').classList.remove('show');
    }
    
    async function loadDrives() {
      try {
        const response = await fetch('/api/get-drives');
        const drives = await response.json();
        
        const drivesList = document.getElementById('drivesList');
        drivesList.innerHTML = drives.map(drive => `
          <div class="drive-item" onclick="browseFolders('${drive.path.replace(/\\/g, '\\\\')}')">
            <div class="drive-icon"><i class="fas fa-hdd"></i></div>
            <div style="font-weight: 600; color: var(--slate-900); margin-bottom: 4px;">${drive.name}</div>
            <div style="font-size: 12px; color: var(--slate-600);">${drive.path}</div>
          </div>
        `).join('');
      } catch (err) {
        alert('Failed to load drives: ' + err.message);
      }
    }
    
    async function browseFolders(path) {
      if (!path) return;
      
      document.getElementById('browserLoading').style.display = 'block';
      document.getElementById('folderSection').style.display = 'none';
      
      try {
        const response = await fetch(`/api/browse-folders?path=${encodeURIComponent(path)}`);
        const data = await response.json();
        
        currentBrowserPath = data.currentPath;
        selectedFolderPath = data.currentPath;
        
        // Hide drives section, show folder section
        document.getElementById('drivesSection').style.display = 'none';
        document.getElementById('folderSection').style.display = 'block';
        
        // Update breadcrumb
        updateBreadcrumb(data.currentPath, data.parentPath);
        
        // Update folder list
        const folderList = document.getElementById('folderList');
        if (data.folders.length === 0) {
          folderList.innerHTML = '<li style="padding: 32px; text-align: center; color: var(--slate-500);"><i class="fas fa-folder-open" style="font-size: 32px; margin-bottom: 12px; display: block; opacity: 0.5;"></i>No subfolders found</li>';
        } else {
          folderList.innerHTML = data.folders.map(folder => `
            <li class="folder-item" onclick="browseFolders('${folder.path.replace(/\\/g, '\\\\')}')">
              <i class="fas fa-folder folder-icon-browser"></i>
              <span style="flex: 1; font-weight: 500; color: var(--slate-800);">${folder.name}</span>
              <i class="fas fa-chevron-right" style="color: var(--slate-400); font-size: 12px;"></i>
            </li>
          `).join('');
        }
        
        // Update selected path display
        document.getElementById('selectedPathDisplay').textContent = data.currentPath;
        
      } catch (err) {
        alert('Failed to browse folders: ' + err.message);
      } finally {
        document.getElementById('browserLoading').style.display = 'none';
      }
    }
    
    function updateBreadcrumb(currentPath, parentPath) {
      const breadcrumb = document.getElementById('breadcrumbBrowser');
      const isWindows = currentPath.includes(':\\');
      
      // Build breadcrumb parts
      let parts = [];
      if (isWindows) {
        const pathParts = currentPath.split('\\').filter(p => p);
        parts = pathParts.map((part, idx) => {
          const path = pathParts.slice(0, idx + 1).join('\\');
          return { name: part, path: path };
        });
      } else {
        const pathParts = currentPath.split('/').filter(p => p);
        parts = [{ name: '/', path: '/' }];
        pathParts.forEach((part, idx) => {
          const path = '/' + pathParts.slice(0, idx + 1).join('/');
          parts.push({ name: part, path: path });
        });
      }
      
      // Create breadcrumb HTML
      const breadcrumbHtml = parts.map((part, idx) => {
        return `
          <span class="breadcrumb-browser-item" onclick="browseFolders('${part.path.replace(/\\/g, '\\\\')}')">${part.name}</span>
          ${idx < parts.length - 1 ? '<span style="color: #999;">/</span>' : ''}
        `;
      }).join('');
      
      breadcrumb.innerHTML = breadcrumbHtml;
    }
    
    function selectCurrentFolder() {
      if (!selectedFolderPath) {
        alert('Please select a folder first');
        return;
      }
      
      document.getElementById('newStoragePath').value = selectedFolderPath;
      closeFolderBrowser();
      showSuccess('storageSuccess', 'Folder selected: ' + selectedFolderPath);
    }
    
    // Backup Management Functions
    async function loadBackups() {
      document.getElementById('backupsLoading').style.display = 'block';
      document.getElementById('backupsList').innerHTML = '';
      
      try {
        const response = await fetch('/api/backups');
        const backups = await response.json();
        
        const backupsList = document.getElementById('backupsList');
        
        if (backups.length === 0) {
          backupsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No backups found</div>';
        } else {
          backupsList.innerHTML = backups.map(backup => {
            const date = new Date(backup.timestamp);
            const dateStr = date.toLocaleString();
            const sizeStr = formatBytes(backup.totalSize);
            const daysAgo = Math.floor((Date.now() - backup.timestamp) / (1000 * 60 * 60 * 24));
            
            return `
              <div class="backup-item">
                <div class="backup-header">
                  <div class="backup-title">
                    <i class="fas fa-calendar-alt"></i>
                    ${backup.day} - Version ${backup.version}
                  </div>
                  <div class="backup-actions">
                    <a href="/browse?day=${backup.day}&version=${backup.version}" target="_blank" class="btn btn-small btn-secondary">
                      <i class="fas fa-eye"></i> View
                    </a>
                    <button onclick="deleteBackup('${backup.day}', ${backup.version})" class="btn btn-danger btn-small">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </div>
                </div>
                <div class="backup-info">
                  <div class="backup-info-item">
                    <span class="backup-info-label"><i class="fas fa-clock"></i> Date</span>
                    <span class="backup-info-value">${dateStr}</span>
                  </div>
                  <div class="backup-info-item">
                    <span class="backup-info-label"><i class="fas fa-history"></i> Age</span>
                    <span class="backup-info-value">${daysAgo} days ago</span>
                  </div>
                  <div class="backup-info-item">
                    <span class="backup-info-label"><i class="fas fa-file"></i> Files</span>
                    <span class="backup-info-value">${backup.fileCount}</span>
                  </div>
                  <div class="backup-info-item">
                    <span class="backup-info-label"><i class="fas fa-database"></i> Size</span>
                    <span class="backup-info-value">${sizeStr}</span>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }
      } catch (err) {
        document.getElementById('backupsList').innerHTML = '<div style="text-align: center; padding: 60px; color: var(--danger);"><i class="fas fa-exclamation-circle" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>Failed to load backups: ' + err.message + '</div>';
      } finally {
        document.getElementById('backupsLoading').style.display = 'none';
      }
    }
    
    async function deleteBackup(day, version) {
      if (!confirm(`Are you sure you want to delete backup ${day} version ${version}?\n\nThis will remove the backup metadata but NOT delete the actual files from storage.`)) {
        return;
      }
      
      try {
        const response = await fetch(`/api/backups/${day}/${version}`, {
          method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
          showSuccess('backupSuccess', 'Backup deleted successfully');
          loadBackups();
          loadStats();
        } else {
          alert('Failed to delete backup: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Failed to delete backup: ' + err.message);
      }
    }
    
    async function deleteOldBackups() {
      const days = prompt('Delete backups older than how many days?', '30');
      if (!days) return;
      
      const cutoffDays = parseInt(days);
      if (isNaN(cutoffDays) || cutoffDays < 1) {
        alert('Please enter a valid number of days');
        return;
      }
      
      if (!confirm(`This will delete all backups older than ${cutoffDays} days. Are you sure?`)) {
        return;
      }
      
      try {
        const response = await fetch('/api/backups');
        const backups = await response.json();
        
        const cutoffTime = Date.now() - (cutoffDays * 24 * 60 * 60 * 1000);
        const oldBackups = backups.filter(b => b.timestamp < cutoffTime);
        
        if (oldBackups.length === 0) {
          alert('No backups found older than ' + cutoffDays + ' days');
          return;
        }
        
        if (!confirm(`Found ${oldBackups.length} old backups. Delete them now?`)) {
          return;
        }
        
        let deleted = 0;
        for (const backup of oldBackups) {
          try {
            const delResponse = await fetch(`/api/backups/${backup.day}/${backup.version}`, {
              method: 'DELETE'
            });
            const data = await delResponse.json();
            if (data.success) deleted++;
          } catch (e) {
            console.error('Failed to delete backup:', e);
          }
        }
        
        showSuccess('backupSuccess', `Deleted ${deleted} old backups`);
        loadBackups();
        loadStats();
      } catch (err) {
        alert('Failed to delete old backups: ' + err.message);
      }
    }
    
    // Initialize backups tab
    if (window.location.hash === '#backups') {
      switchTab('backups');
    }
  </script>
</body>
</html>
  